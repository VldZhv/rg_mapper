2.2
# RG Tags Mapper

## Назначение
RG Tags Mapper — приложение для подготовки планов помещений и привязки к ним радиометок (якорей), зон воспроизведения и аудиотреков аудиогидов. Программа помогает сформировать рабочую конфигурацию для устройств RadioGuide HP-23, а также позволяет сохранять проект для последующего редактирования.

## Основные возможности
### Работа с планом и проектами
- Загрузка плана-схемы помещения в форматах PNG, JPG или BMP.
- Калибровка масштаба по двум точкам с заданием длины в сантиметрах и шага координатной сетки.
- Автоматическое наложение сетки и пересчёт координат при изменении параметров плана.
- Сохранение текущего состояния в проект (.proj) и повторная загрузка для продолжения работы.
- Экспорт изображения сцены в PDF с учётом сетки и всех объектов.

### Управление объектами на плане
- Создание, редактирование и удаление залов с указанием размеров и названия; при переносе зала связанные якоря смещаются автоматически.
- Точный контроль координат залов, зон и якорей с привязкой к сетке и пересчётом значений в метры.
- Добавление якорей с указанием номера, координаты Z (в метрах), списка дополнительных залов и признака «Переходный» для межзонных точек.
- Создание зон трёх типов: входная, выходная и переходная. Для каждой зоны можно задать габариты, положение, угол поворота и индивидуальный аудиотрек.
- Единое контекстное меню по двойному клику или правой кнопке для быстрого доступа к редактированию и удалению объектов, приоритет отдаётся якорям и более мелким зонам.

### Аудиосопровождение
- Привязка основного аудиотрека MP3 к залу и/или отдельной зоне. Для входных зон доступна загрузка файла прямо из диалога настройки.
- Поддержка дополнительного MP3-файла для каждой записи, а также индивидуального отображаемого имени трека.
- Настройка флагов «Прерываемый», «Сброс» и «Играть единожды», а также списка дополнительных ID для совместной работы нескольких радиометок.
- Автоматическое извлечение длительности и размера файла, хранение данных в проекте и в экспортируемых JSON-файлах.

### Импорт и экспорт данных
- Экспорт объектов (залы, зоны, якоря) в `rooms.json` и аудиотреков с данными файлов в `tracks.json`.
- Импорт `rooms.json` с автоматическим обновлением размеров залов и перечня зон/якорей (требуется предварительная калибровка).
- Импорт `tracks.json` для массовой загрузки звуковых файлов и их параметров.
- Раздельные команды импорта/экспорта доступны из меню и контекстного меню кнопок на панели инструментов.
- Выгрузка текущей конфигурации на сервер по SSH/SFTP с использованием ключей PuTTY (`.ppk`).

### Интерфейс и дополнительные инструменты
- Две боковые панели: «Список объектов» (по умолчанию открыта) и «Список треков» (включается через меню «Вид»). Панели можно откреплять и перемещать.
- Панель «Список объектов» группирует данные по залам и показывает координаты якорей и зон с округлением до 0,1 м.
- Панель «Список треков» позволяет редактировать параметры аудио без открытия диалогов: менять имена, дополнительные ID, флаги воспроизведения и переносить треки между залами.
- Кнопка «Закрепить объекты» блокирует перемещение залов, зон и/или якорей (по отдельности).
- Стек отмены с ограничением на 30 шагов: команда «Отменить» и сочетание `Ctrl+Z` возвращают предыдущее состояние, при этом в статус-бар выводятся подсказки.
- Поддержка масштабирования колесом мыши (с фокусом под курсором) и панорамирования средней кнопкой или удержанием левой кнопки по пустой области.

## Основные элементы интерфейса
- **Главное меню**
  - «Файл»: создание нового проекта, сохранение, загрузка, импорт/экспорт, выгрузка на сервер и сохранение в PDF.
  - «Правка»: отмена действия и блокировка объектов.
  - «Инструменты»: калибровка, добавление залов, якорей и зон.
  - «Вид»: отображение боковых панелей.
  - «Справка»: открытие данного файла в отдельном окне и сведения «О приложении» (версия считывается из первой строки README).
- **Панели инструментов** с крупными иконками для быстрых действий (открытие проекта, сохранение, импорт/экспорт, калибровка, добавление объектов, блокировка и отмена).
- **Строка состояния** отображает подсказки о текущем режиме и результатах операций.

## Типовой сценарий работы
1. Запустите приложение. В статус-баре появится подсказка «Загрузите изображение для начала работы».
2. Нажмите «Новый проект», выберите файл плана помещения и подтвердите переход к калибровке.
3. Укажите на изображении две точки с известным реальным расстоянием, введите длину в сантиметрах и шаг сетки (по умолчанию 10 см).
4. При необходимости повторите калибровку из меню «Инструменты» → «Выполнить калибровку».
5. Создайте залы: выделите прямоугольную область, задайте номер и название, при необходимости загрузите основной аудиотрек прямо в диалоге редактирования.
6. Добавьте якоря внутри нужных залов. После создания якорь можно перемещать, выводя координаты в списке объектов; допускается вынос за пределы зала. В диалоге редактирования задаются дополнительные залы и флаг «Переходный».
7. Создайте зоны внутри залов. Для каждой зоны задайте тип (входная, выходная, переходная), параметры и, при необходимости, аудиотрек. Для входных зон трек можно загрузить сразу.
8. Используйте правый клик или двойной клик по объекту для редактирования и удаления. Перекрывающиеся элементы выбираются автоматически с учётом приоритетов (якоря → меньшие зоны → зал).
9. В панели «Список треков» настройте параметры аудиофайлов, дополнительные ID и флаги воспроизведения. Здесь же можно перенести трек в другой зал, изменив номер в соответствующей колонке.
10. Сохраните проект (`.proj`) для продолжения работы, экспортируйте `rooms.json` и/или `tracks.json` для аудиогидов. При необходимости создайте PDF с визуальной схемой.

## Работа с аудиотреками
- При выборе MP3-файла автоматически извлекается название, длительность и размер; данные сохраняются в проекте и экспортируются вместе с файлом в base64.
- Для каждого трека можно добавить вторую дорожку (кнопка «Добавить MP3…») — она также сохраняется в проекте и экспортируется.
- Поле «Дополнительные ID» принимает список чисел через запятую. Эти значения учитываются при экспорте и позволяют связать один трек с несколькими метками.
- Флаги:
  - **Прерываемый** — трек может быть остановлен другим событием (включён по умолчанию).
  - **Сброс** — запуск данного трека сбрасывает историю воспроизведения в аудиогиде.
  - **Играть единожды** — трек воспроизводится только один раз, без зацикливания.
- Панель «Список треков» синхронизирована с диалогами: изменения, внесённые в таблице, автоматически попадают в проект, поддерживается отмена последних правок.

## Форматы сохраняемых файлов
- **`.proj`** — полный снимок проекта: изображение плана, параметры сетки, залы, зоны, якоря и все аудиофайлы (в base64).
- **`rooms.json`** — структура объектов для аудиогидов: размеры залов, координаты зон и привязка якорей. Экспорт включает флаг «Переходный» и дополнительные залы для якорей.
- **`tracks.json`** — перечень аудиотреков с именами файлов, дополнительными ID, настройками воспроизведения и встроенными бинарными данными MP3. Подходит для импорта в другое рабочее место.
- **`PDF`** — статическое изображение текущего плана для печати или согласования.

## Горячие клавиши и советы
- `Ctrl+Z` — отмена последнего действия.
- `Delete` — удаление выделенных залов, зон или якорей.
- Удерживайте `Ctrl`, чтобы выбирать несколько объектов на сцене.
- Колесо мыши масштабирует сцену относительно курсора; средняя кнопка или перетаскивание пустой области левой кнопкой включает панорамирование.
- При перетаскивании объекты автоматически притягиваются к шагу сетки, что облегчает точное позиционирование.

